name: Deploy Monorepo to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_db_migrations:
        description: "Run backend DB push after deploy"
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    env:
      BRANCH: main
      RUN_DB_MIGRATIONS: ${{ inputs.run_db_migrations && 'true' || 'false' }}
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script_stop: true
          envs: BRANCH,RUN_DB_MIGRATIONS
          script: |
            set -euo pipefail

            APP_DIR="$HOME/apps/jadmin"

            REPO_URL="${{ secrets.REPO_URL }}"
            if [ -z "$REPO_URL" ]; then
              echo "ERROR: REPO_URL secret is empty"
              exit 1
            fi

            echo "Deploying ${BRANCH} to ${APP_DIR}"

            mkdir -p "$(dirname "$APP_DIR")"
            if [ ! -d "$APP_DIR/.git" ]; then
              git clone "$REPO_URL" "$APP_DIR"
            fi

            cd "$APP_DIR"
            git remote set-url origin "$REPO_URL"
            git fetch --prune origin "$BRANCH"
            git checkout -B "$BRANCH" "origin/$BRANCH"

            if [ ! -f .env ]; then
              echo "ERROR: .env file not found in $APP_DIR"
              echo "Create it from .env.example before deploying"
              exit 1
            fi

            docker network inspect web >/dev/null 2>&1 || docker network create web

            docker compose config -q
            docker compose build --pull backend frontend
            docker compose up -d --remove-orphans

            if [ "$RUN_DB_MIGRATIONS" = "true" ]; then
              echo "Running DB migrations..."
              docker compose exec -T backend npm run db:push
            fi

            docker compose ps
            docker compose logs --tail=80 backend
            docker compose logs --tail=80 frontend

            docker image prune -f
            echo "âœ… Deploy complete"
